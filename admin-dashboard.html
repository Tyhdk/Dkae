<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Crypto Miner</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <style>
    /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© */
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; padding: 0;
      background: radial-gradient(circle at top, #0f172a, #000000);
      color: #f9fafb;
      font-family: 'Cairo', sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex; flex-direction: column;
    }
    
    .page { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 90px; scroll-behavior: smooth; max-width: 800px; margin: 0 auto; width: 100%; }
    .page-section { display: none; }
    .page-section.active { display: block; animation: fadeInUp 0.4s ease-in-out; }

    /* Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
    .bottom-nav {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 95%; height: 65px;
      background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
      display: flex; justify-content: space-around; align-items: center;
      z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #64748b; font-size: 9px; cursor: pointer; width: 20%; height: 100%;
      transition: all 0.3s;
    }
    .nav-item.active { color: #f59e0b; transform: translateY(-4px); font-weight: bold; }
    .nav-icon { font-size: 20px; margin-bottom: 3px; }

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card {
      background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 20px;
      padding: 18px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }
    h2, h3 { margin: 0 0 10px 0; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .muted { font-size: 12px; color: #94a3b8; line-height: 1.6; }

    .field { margin-bottom: 12px; }
    .field label { display: block; font-size: 13px; margin-bottom: 6px; color: #cbd5e1; font-weight: 600; }
    .field input, .field textarea {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 2px solid #334155; background: #020617; color: #fff;
      font-size: 14px; resize: none; transition: all 0.3s;
    }
    .field input:focus, .field textarea:focus { border-color: #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.2); }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    button {
      border: none; border-radius: 12px; padding: 12px; font-size: 14px;
      cursor: pointer; width: 100%; font-weight: 700;
      display: flex; align-items: center; justify-content: center; gap: 6px;
      transition: transform 0.1s;
    }
    .btn-main { background: linear-gradient(to bottom, #f59e0b, #d97706); color: #fff; }
    .btn-secondary { background: #334155; color: #e2e8f0; }
    .btn-danger { background: linear-gradient(to bottom, #ef4444, #dc2626); color: #fff; }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .stat-card { background: rgba(15, 23, 42, 0.4); border-radius: 14px; border: 1px solid #334155; padding: 12px; text-align: center; }
    .stat-value { font-size: 20px; font-weight: 800; color: #fff; }

    /* Ø¬Ø¯Ø§ÙˆÙ„ */
    table { width: 100%; border-collapse: separate; border-spacing: 0 6px; font-size: 12px; }
    td { padding: 10px; background: rgba(30, 41, 59, 0.4); border-top: 1px solid #334155; border-bottom: 1px solid #334155; }
    td:first-child { border-right: 1px solid #334155; border-radius: 0 10px 10px 0; }
    td:last-child { border-left: 1px solid #334155; border-radius: 10px 0 0 10px; }
    .table-header { font-weight: bold; color: #f59e0b; padding: 5px 10px; background: rgba(15, 23, 42, 0.6); }

    /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ */
    .wd-amount { font-size: 16px; color: #4ade80; font-weight: bold; }
    .wd-wallet { 
      font-family: monospace; background: rgba(0,0,0,0.3); 
      padding: 6px; border-radius: 6px; color: #f59e0b; 
      font-size: 11px; display: block; margin-top: 6px; 
      word-break: break-all; cursor: pointer; border: 1px dashed rgba(245, 158, 11, 0.3);
    }
    .wd-wallet:active { background: rgba(245, 158, 11, 0.1); }
  </style>
</head>
<body>

<div class="page">
  <div id="authNotice" class="card animate__animated animate__fadeInDown" style="text-align:center; margin-top:50px;">
    <h1>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h1>
    <div id="authStatus" class="muted" style="margin-top:10px; color:#fbbf24;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©...</div>
  </div>

  <div id="adminWrapper" style="display:none;">
    <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="margin:0;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… âš™ï¸</h3>
      <button id="logoutBtn" class="btn-danger" style="width:auto; padding:6px 12px;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="tab-home" class="page-section active">
      <div class="card">
        <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <div class="stats-grid">
          <div class="stat-card"><div>ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div><div class="stat-value" id="statTotalUsers">0</div></div>
          <div class="stat-card"><div>ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª</div><div class="stat-value" style="color:#4ade80;" id="statTotalTopup">0</div></div>
          <div class="stat-card"><div>ğŸ’¸ Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚</div><div class="stat-value" style="color:#f59e0b;" id="statTotalCommission">0</div></div>
          <div class="stat-card" style="grid-column: span 3; border-color: #fb923c;"><div style="font-size:14px; font-weight:bold;">â³ Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div><div class="stat-value" id="statPendingWithdraw">0</div></div>
        </div>
      </div>
    </div>

    <div id="tab-news" class="page-section">
      <div class="card">
        <h2>ğŸ“° Ù†Ø´Ø± Ø®Ø¨Ø±</h2>
        <div class="field"><label>Ø§Ù„Ø±Ø§Ø¨Ø· (ØµÙˆØ±Ø©/ÙÙŠØ¯ÙŠÙˆ/Drive)</label><input type="text" id="newsMediaInput"></div>
        <div class="field"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="newsTitleInput"></div>
        <div class="field"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="newsDescInput" rows="2"></textarea></div>
        <div class="row">
          <div class="field" style="flex:1;"><label>Ù„Ø§ÙŠÙƒØ§Øª</label><input type="number" id="newsLikesInput" value="300"></div>
          <div class="field" style="flex:1;"><label>Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</label><input type="number" id="newsViewsInput" value="240"></div>
        </div>
        <button id="createNewsBtn" class="btn-main">Ù†Ø´Ø±</button>
        <div id="newsMsg" class="muted"></div>
      </div>
      <div id="newsList" class="card"></div>
    </div>

    <div id="tab-plans" class="page-section">
      <div class="card">
        <h2>ğŸš€ Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚Ø©</h2>
        <div class="field"><label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="planTitleInput"></div>
        <div class="field"><label>ØµÙˆØ±Ø© (Drive/Link)</label><input type="text" id="planImageInput"></div>
        <div class="row">
          <div class="field" style="flex:1;"><label>Ø§Ù„Ø³Ø¹Ø± ($)</label><input type="number" id="planPriceInput"></div>
          <div class="field" style="flex:1;"><label>Ø§Ù„Ø±Ø¨Ø­ ($)</label><input type="number" id="planDailyProfitInput"></div>
        </div>
        <div class="row">
          <div class="field" style="flex:1;"><label>Ø§Ù„Ù…Ø¯Ø© (ÙŠÙˆÙ…)</label><input type="number" id="planDurationInput"></div>
          <div class="field" style="flex:1;"><label>ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ† (Ø«Ø§Ù†ÙŠØ©)</label><input type="number" id="planMiningTimeInput" value="5"></div>
        </div>
        <button id="createPlanBtn" class="btn-main">Ù†Ø´Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
        <div id="planMsg" class="muted"></div>
      </div>
      <div id="plansList" class="card"></div>
    </div>

    <div id="tab-users" class="page-section">
      <div class="card">
        <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ùˆ Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</h2>
        <div style="border-bottom: 1px dashed #334155; padding-bottom: 15px; margin-bottom: 15px;">
            <div class="field"><label>ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø´Ø­Ù†</label><input type="text" id="topupUserIdInput"></div>
            <div class="field"><label>Ø§Ù„Ù…Ø¨Ù„Øº ($)</label><input type="number" id="topupAmountInput"></div>
            <button id="topupBtn" class="btn-main">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</button>
            <div id="topupMsg" class="muted"></div>
        </div>
        
        <h3 style="margin-top:0;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ğŸ“œ</h3>
        <div id="usersListMsg" class="muted">Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>
        <table style="width:100%">
            <thead>
                <tr>
                    <td class="table-header">ID/Ø§Ù„Ø§Ø³Ù…</td>
                    <td class="table-header">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª</td>
                    <td class="table-header">Ø§Ù„Ù…Ø­ÙŠÙ„</td>
                    <td class="table-header" style="text-align:center;">Ø¥Ø¯Ø§Ø±Ø©</td>
                </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
        </table>
      </div>
    </div>
    
    <div id="userDetailsModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:5000; display:none; justify-content:center; align-items:center;">
        <div class="card animate__animated animate__zoomIn" style="max-width:350px; width:90%;">
            <h3 id="modalUserName">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
            <div id="modalContent">
                </div>
            <button class="btn-secondary" onclick="document.getElementById('userDetailsModal').style.display='none';" style="margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="tab-withdraw" class="page-section">
      <div class="card">
        <h2>ğŸ“¤ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
        <div id="withdrawMsg" class="muted"></div>
        <table style="width:100%">
          <tbody id="withdrawTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<nav class="bottom-nav" id="bottomNav" style="display:none;">
  <div class="nav-item active" onclick="switchTab('home', this)"><span class="nav-icon">ğŸ“Š</span></div>
  <div class="nav-item" onclick="switchTab('news', this)"><span class="nav-icon">ğŸ“°</span></div>
  <div class="nav-item" onclick="switchTab('plans', this)"><span class="nav-icon">ğŸš€</span></div>
  <div class="nav-item" onclick="switchTab('users', this)"><span class="nav-icon">ğŸ‘¥</span></div>
  <div class="nav-item" onclick="switchTab('withdraw', this)"><span class="nav-icon">ğŸ“¤</span></div>
</nav>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
      apiKey: "AIzaSyAPdLvL9yTmGaGRjcmFrTKcKSamL_Zso_s",
      authDomain: "sthmar-ff2e2.firebaseapp.com",
      projectId: "sthmar-ff2e2",
      storageBucket: "sthmar-ff2e2.firebasestorage.app",
      messagingSenderId: "456664476578",
      appId: "1:456664476578:web:3939cd5e00ba1b5a50e0fb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const ADMIN_PASSWORD = "nasm1998";

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
  function processMediaUrl(url) {
    if (!url) return { type: 'image', src: 'https://placehold.co/100' };
    if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
      let fileId = null; const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
      if (match && match[1]) fileId = match[1]; else { const u = new URL(url); fileId = u.searchParams.get("id"); }
      if (fileId) return { type: 'iframe', src: `https://drive.google.com/file/d/${fileId}/preview` };
    }
    if (url.match(/\.(mp4|webm|ogg)$/i)) return { type: 'video', src: url };
    return { type: 'image', src: url };
  }
  
  function getMediaHTML(url, h="50px") {
    const m = processMediaUrl(url);
    if(m.type==='iframe') return `<iframe src="${m.src}" style="width:${h};height:${h};border:none;border-radius:8px;"></iframe>`;
    if(m.type==='video') return `<video src="${m.src}" style="width:${h};height:${h};object-fit:cover;border-radius:8px;"></video>`;
    return `<img src="${m.src}" style="width:${h};height:${h};object-fit:cover;border-radius:8px;">`;
  }

  // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  window.switchTab = function(tabName, el) {
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    if(tabName==='news') loadNews();
    if(tabName==='plans') loadPlans();
    if(tabName==='withdraw') loadWithdrawRequests();
    if(tabName==='users') loadUsers(); // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  };

  // Auth
  document.getElementById('logoutBtn').onclick = () => { location.reload(); };
  
  setTimeout(() => {
    const pass = prompt("Ø±Ù…Ø² Ø§Ù„Ø£Ø¯Ù…Ù†:");
    if (pass === ADMIN_PASSWORD) {
      document.getElementById('authNotice').style.display='none';
      document.getElementById('adminWrapper').style.display='block';
      document.getElementById('bottomNav').style.display='flex';
      loadStats();
    } else { document.getElementById('authStatus').innerText="Ø±Ù…Ø² Ø®Ø§Ø·Ø¦"; }
  }, 500);

  // News Logic
  document.getElementById('createNewsBtn').onclick = async () => {
    const t = document.getElementById('newsTitleInput').value;
    const d = document.getElementById('newsDescInput').value;
    const m = document.getElementById('newsMediaInput').value;
    const l = document.getElementById('newsLikesInput').value;
    const v = document.getElementById('newsViewsInput').value;
    if(!t) return alert('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨');
    await addDoc(collection(db,"news"), { title:t, description:d, mediaUrl:m, startLikes:Number(l), startViews:Number(v), createdAt:serverTimestamp() });
    alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±"); loadNews();
  };

  async function loadNews() {
    const list = document.getElementById('newsList'); list.innerHTML='ØªØ­Ù…ÙŠÙ„...';
    try {
      const q = query(collection(db,"news"), orderBy("createdAt","desc"));
      const s = await getDocs(q); list.innerHTML='';
      s.forEach(d => {
        const dt = d.data();
        list.innerHTML += `<div style="border-bottom:1px solid #334155; padding:10px; display:flex; gap:10px; align-items:center;">
          ${getMediaHTML(dt.mediaUrl)}
          <div style="flex:1;"><b>${dt.title}</b><br><span class="muted">${dt.description}</span></div>
          <button class="btn-danger" style="width:auto;padding:5px;" onclick="delDoc('news','${d.id}')">ğŸ—‘ï¸</button>
        </div>`;
      });
    } catch(e) { list.innerHTML="Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"; }
  }

  // Plans Logic (With Mining Time)
  document.getElementById('createPlanBtn').onclick = async () => {
    const t = document.getElementById('planTitleInput').value;
    const img = document.getElementById('planImageInput').value;
    const p = document.getElementById('planPriceInput').value;
    const dp = document.getElementById('planDailyProfitInput').value;
    const dur = document.getElementById('planDurationInput').value;
    const mineTime = document.getElementById('planMiningTimeInput').value;

    if(!t || !p) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
    
    await addDoc(collection(db,"plans"), {
      title:t, imageUrl:img, price:Number(p), dailyProfit:Number(dp),
      durationDays:Number(dur), miningTime: Number(mineTime) * 1000, 
      active:true, createdAt:serverTimestamp()
    });
    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù‚Ø©"); loadPlans();
  };

  async function loadPlans() {
    const list = document.getElementById('plansList'); list.innerHTML='ØªØ­Ù…ÙŠÙ„...';
    const s = await getDocs(query(collection(db,"plans"), orderBy("createdAt","desc")));
    list.innerHTML='';
    s.forEach(d => {
      const dt = d.data();
      list.innerHTML += `<div style="border-bottom:1px solid #334155; padding:10px; display:flex; gap:10px; align-items:center;">
        ${getMediaHTML(dt.imageUrl)}
        <div style="flex:1;"><b>${dt.title}</b><br><span class="muted">${dt.price}$ | Ø±Ø¨Ø­ ${dt.dailyProfit}$ | ${dt.miningTime/1000} Ø«Ø§Ù†ÙŠØ©</span></div>
        <button class="btn-secondary" style="width:auto;padding:5px;" onclick="togglePlan('${d.id}',${dt.active})">${dt.active?'ØªØ¹Ø·ÙŠÙ„':'ØªÙØ¹ÙŠÙ„'}</button>
      </div>`;
    });
  }
  window.togglePlan = async (id, st) => { await updateDoc(doc(db,"plans",id), {active:!st}); loadPlans(); };

  // Withdraw Logic (Updated for new fields)
  async function loadWithdrawRequests() {
    const tb = document.getElementById('withdrawTableBody'); tb.innerHTML='<tr><td colspan="2">ØªØ­Ù…ÙŠÙ„...</td></tr>';
    try {
      const q = query(collection(db,"deposit_requests"), where("status","==","new"), orderBy("createdAt","desc"));
      const s = await getDocs(q);
      if(s.empty) { tb.innerHTML='<tr><td colspan="2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</td></tr>'; return; }
      
      tb.innerHTML='';
      s.forEach(d => {
        const dt = d.data();
        const amount = dt.amount ? `${dt.amount} $` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const wallet = dt.walletAddress || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­ÙØ¸Ø©';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="wd-amount">${amount}</div>
            <div class="muted">ğŸ‘¤ ${dt.userName || dt.userId}</div>
            <span class="wd-wallet" onclick="navigator.clipboard.writeText('${wallet}');alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø­ÙØ¸Ø©: ${wallet}')">${wallet} ğŸ“‹</span>
          </td>
          <td style="vertical-align:middle; width:80px;">
            <button class="btn-main" style="margin-bottom:5px; background:#22c55e;" onclick="handleWD('${d.id}','approved')">âœ”</button>
            <button class="btn-danger" onclick="handleWD('${d.id}','rejected')">âœ–</button>
          </td>
        `;
        tb.appendChild(row);
      });
    } catch(e) { tb.innerHTML=`<tr><td colspan="2" style="color:red">Ø®Ø·Ø£: ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙÙ‡Ø±Ø³ (status + createdAt)</td></tr>`; }
  }

  window.handleWD = async (id, st) => {
    if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ")) return;
    await updateDoc(doc(db,"deposit_requests",id), {status:st});
    loadWithdrawRequests(); loadStats();
  };

  // Topup Logic
  document.getElementById('topupBtn').onclick = async () => {
    const uid = document.getElementById('topupUserIdInput').value;
    const amt = Number(document.getElementById('topupAmountInput').value);
    if(!uid || !amt || amt <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID ØµØ­ÙŠØ­ ÙˆÙ…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
    
    document.getElementById('topupMsg').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø´Ø­Ù†...";
    try {
      const uRef = doc(db,"users",uid);
      const snap = await getDoc(uRef);
      if(!snap.exists()) {
        document.getElementById('topupMsg').innerText = "Ø®Ø·Ø£: Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        return;
      }
      await updateDoc(uRef, { walletBalance: (snap.data().walletBalance||0) + amt });
      await addDoc(collection(db,"wallet_topups"), {userId:uid, amount:amt, createdAt:serverTimestamp()});
      document.getElementById('topupMsg').innerText = `ØªÙ… Ø´Ø­Ù† ${amt}$ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.`;
      loadStats();
    } catch(e){ 
      document.getElementById('topupMsg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."; 
    }
  };

  // ** Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø¥Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ **

  const usersCache = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¬Ù„Ø¨

  async function loadUsers() {
    const tableBody = document.getElementById('usersTableBody');
    const msg = document.getElementById('usersListMsg');
    msg.innerText = "Ø¬Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...";
    tableBody.innerHTML = '';
    
    try {
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      const q = query(collection(db, "users"), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      
      if (snap.empty) {
        msg.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ†.";
        return;
      }
      
      let allUsers = [];
      snap.forEach(d => {
        const data = d.data();
        usersCache[d.id] = data; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        allUsers.push({ id: d.id, ...data });
      });

      // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ÙŠÙ„ÙŠÙ† (Referred By Names) Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
      const uidsToFetch = allUsers.map(u => u.referredBy).filter(id => id && !usersCache[id]);
      
      // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ÙŠÙ„ÙŠÙ†ØŒ ÙˆÙ„ÙƒÙ† Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯ ÙˆØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø³Ø±Ø¹Ø©:
      // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹.
      
      tableBody.innerHTML = '';
      allUsers.forEach(u => {
        const earnings = Number(u.teamTotalEarnings || 0).toFixed(2);
        const refId = u.referredBy || '-';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div style="color:#f59e0b; font-weight:bold; font-size:13px;">${u.uid.substring(0, 8)}...</div>
            <div class="muted" style="font-size:11px;">${u.name || u.email}</div>
          </td>
          <td><span style="color:#4ade80;">${earnings}$</span></td>
          <td><span class="muted">${refId.substring(0, 8)}...</span></td>
          <td style="text-align:center;">
            <button class="btn-secondary" style="width:auto; padding:5px 10px; font-size:11px;" onclick="showUserDetails('${u.uid}')">ØªÙØ§ØµÙŠÙ„</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
      
      msg.innerText = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allUsers.length} Ù…Ø³ØªØ®Ø¯Ù….`;
      
    } catch(e) {
      msg.innerText = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: " + e.message;
      console.error(e);
    }
  }

  window.showUserDetails = async (uid) => {
      const modal = document.getElementById('userDetailsModal');
      const nameHeader = document.getElementById('modalUserName');
      const content = document.getElementById('modalContent');
      content.innerHTML = 'Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
      modal.style.display = 'flex';
      
      try {
          const userData = usersCache[uid] || (await getDoc(doc(db, "users", uid))).data();
          if (!userData) throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©");

          // Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­ÙŠÙ„ (Upline User)
          let referredByName = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ÙŠÙ„';
          if (userData.referredBy) {
              const refSnap = await getDoc(doc(db, "users", userData.referredBy));
              if (refSnap.exists()) {
                  referredByName = `${refSnap.data().name} (${userData.referredBy.substring(0, 6)}...)`;
              } else {
                  referredByName = `${userData.referredBy.substring(0, 8)}... (Ù…Ø­Ø°ÙˆÙ)`;
              }
          }

          // Ø¬Ù„Ø¨ Ø£Ø¹Ø¶Ø§Ø¡ ÙØ±ÙŠÙ‚ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Downline Users)
          const teamQuery = query(collection(db, "users"), where("referredBy", "==", uid));
          const teamSnap = await getDocs(teamQuery);
          const teamCount = teamSnap.size;
          
          nameHeader.innerText = `ğŸ‘¤ ${userData.name || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ù…Ù‰'}`;

          content.innerHTML = `
            <div style="font-size:13px; line-height:2;">
                <p><strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> <span style="color:#4ade80;">${Number(userData.walletBalance || 0).toFixed(2)}$</span></p>
                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª:</strong> <span style="color:#f59e0b;">${Number(userData.teamTotalEarnings || 0).toFixed(2)}$</span></p>
                <p><strong>Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„ÙØ±ÙŠÙ‚:</strong> <span>${teamCount} Ø¹Ø¶Ùˆ</span></p>
                <p><strong>Ø§Ù„Ù…Ø­ÙŠÙ„ (Up-line):</strong> <span class="muted">${referredByName}</span></p>
                <p><strong>Ø§Ù„Ù…Ø¹Ø±Ù (ID):</strong> <span class="muted" style="font-size:11px; word-break:break-all;">${userData.uid}</span></p>
                <p><strong>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</strong> <span class="muted">${userData.email}</span></p>
                <p><strong>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ù…Ø®Ø²Ù†Ø©:</strong> <span class="muted">${userData.password || 'ØºÙŠØ± Ù…Ø®Ø²Ù†Ø©'}</span></p>
                <p><strong>Ù…Ø­ÙØ¸Ø© USDT:</strong> <span class="wd-wallet" style="cursor:default; font-size:11px;">${userData.walletAddress || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©'}</span></p>
            </div>
          `;
          
      } catch(e) {
          content.innerHTML = `<span style="color:red;">Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${e.message}</span>`;
      }
  }


  // Helpers
  window.delDoc = async (c,id) => { if(confirm("Ø­Ø°ÙØŸ")) { await deleteDoc(doc(db,c,id)); if(c==='news') loadNews(); } };
  
  async function loadStats() {
    const u = await getDocs(collection(db,"users"));
    document.getElementById('statTotalUsers').innerText = u.size;
    
    const t = await getDocs(collection(db,"wallet_topups"));
    let sumT = 0; t.forEach(d=> sumT+=d.data().amount||0);
    document.getElementById('statTotalTopup').innerText = sumT.toFixed(2);

    const w = await getDocs(query(collection(db,"deposit_requests"), where("status","==","new")));
    document.getElementById('statPendingWithdraw').innerText = w.size;
    
    // ** Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª **
    let totalCommission = 0;
    u.forEach(d => { totalCommission += d.data().teamTotalEarnings || 0; });
    document.getElementById('statTotalCommission').innerText = totalCommission.toFixed(2) + '$';
  }
</script>
</body>
</html>
